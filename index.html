<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventapel SC - Prospec√ß√£o PMEs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-ventapel { background-color: #3B5BA8; }
        .text-ventapel { color: #3B5BA8; }
        .hover\:bg-ventapel:hover { background-color: #2d4680; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-ventapel shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-2xl">üéØ</div>
                    <div>
                        <h1 class="text-2xl font-bold text-white">Ventapel SC - Pequenas Empresas</h1>
                        <p class="text-blue-100 text-sm">Prospec√ß√£o inteligente em Santa Catarina</p>
                    </div>
                </div>
                <div class="flex gap-4 text-white">
                    <div class="text-right">
                        <p class="text-xs text-blue-100">Apollo</p>
                        <p class="text-xl font-bold" id="apollo-credits">0</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-blue-100">Lusha</p>
                        <p class="text-xl font-bold text-yellow-300" id="lusha-credits">0</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-lg font-semibold mb-4">üîç Filtros de Busca</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">üèôÔ∏è Cidade</label>
                    <select id="city-filter" class="w-full px-4 py-2 border rounded-lg">
                        <option value="">Todas em SC</option>
                        <option value="Joinville">Joinville</option>
                        <option value="Blumenau">Blumenau</option>
                        <option value="Florian√≥polis">Florian√≥polis</option>
                        <option value="Itaja√≠">Itaja√≠</option>
                        <option value="Balne√°rio Cambori√∫">Balne√°rio Cambori√∫</option>
                        <option value="Chapec√≥">Chapec√≥</option>
                        <option value="Lages">Lages</option>
                        <option value="Crici√∫ma">Crici√∫ma</option>
                        <option value="Jaragu√° do Sul">Jaragu√° do Sul</option>
                        <option value="S√£o Bento do Sul">S√£o Bento do Sul</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">üè≠ Ind√∫stria</label>
                    <select id="industry-filter" class="w-full px-4 py-2 border rounded-lg">
                        <option value="">Todas</option>
                        <option value="ecommerce">E-commerce / Loja Online</option>
                        <option value="distributor">Distribuidora</option>
                        <option value="logistics">Log√≠stica / 3PL</option>
                        <option value="manufacturer">Fabricante / Ind√∫stria</option>
                        <option value="autope√ßas">Autope√ßas</option>
                        <option value="furniture">M√≥veis</option>
                        <option value="food">Alimentos</option>
                        <option value="pharmaceutical">Farmac√™utico</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">üë• Tamanho</label>
                    <select id="size-filter" class="w-full px-4 py-2 border rounded-lg">
                        <option value="">1-500 funcion√°rios</option>
                        <option value="1,50">1-50</option>
                        <option value="51,200">51-200</option>
                        <option value="201,500">201-500</option>
                    </select>
                </div>
            </div>

            <button onclick="searchCompanies()" id="search-btn" class="mt-6 w-full bg-ventapel hover:bg-ventapel text-white font-semibold py-3 px-6 rounded-lg">
                üöÄ Buscar Empresas
            </button>
        </div>

        <!-- Results -->
        <div id="results-container"></div>
    </div>

    <script>
        let enrichedContacts = JSON.parse(localStorage.getItem('enriched_contacts') || '{}');

        async function searchCompanies() {
            const btn = document.getElementById('search-btn');
            const container = document.getElementById('results-container');
            
            btn.disabled = true;
            btn.innerHTML = 'üîÑ Buscando...';
            
            const industryValue = document.getElementById('industry-filter').value;
            
            const filters = {
                city: document.getElementById('city-filter').value,
                size: document.getElementById('size-filter').value,
                keywords: industryValue ? [industryValue] : []
            };

            console.log('Filters:', filters);

            try {
                const response = await fetch('/api/1-search-small-companies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filters, page: 1 })
                });
                
                const data = await response.json();
                
                console.log('Response:', data);
                
                if (data.success) {
                    document.getElementById('apollo-credits').textContent = data.apollo_credits_used || 0;
                    renderCompanies(data.organizations);
                } else {
                    alert('Erro na busca: ' + data.error);
                }
            } catch (error) {
                console.error('Search error:', error);
                alert('Erro na busca. Verifique o console.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Buscar Empresas';
            }
        }

        function renderCompanies(companies) {
            const container = document.getElementById('results-container');
            
            if (!companies || companies.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <div class="text-6xl mb-4">üîç</div>
                        <h3 class="text-xl font-semibold mb-2">Nenhuma empresa encontrada</h3>
                        <p class="text-gray-600">Ajuste os filtros e tente novamente</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <h2 class="text-xl font-bold mb-4">üìä ${companies.length} empresas encontradas</h2>
                <div class="space-y-6">
                    ${companies.map(company => renderCompany(company)).join('')}
                </div>
            `;
        }

        function renderCompany(company) {
            const socialLinks = [];
            if (company.website) {
                socialLinks.push(`<a href="${company.website}" target="_blank" class="text-blue-100 hover:text-white underline">üåê Website</a>`);
            }
            if (company.linkedin) {
                socialLinks.push(`<a href="${company.linkedin}" target="_blank" class="text-blue-100 hover:text-white underline">üíº LinkedIn</a>`);
            }
            if (company.instagram) {
                socialLinks.push(`<a href="${company.instagram}" target="_blank" class="text-blue-100 hover:text-white underline">üì∏ Instagram</a>`);
            }
            if (company.facebook) {
                socialLinks.push(`<a href="${company.facebook}" target="_blank" class="text-blue-100 hover:text-white underline">üë• Facebook</a>`);
            }
            
            return `
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 p-6 text-white">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="text-2xl font-bold mb-2">${company.name}</h3>
                                <div class="flex gap-3 text-sm flex-wrap mb-2">
                                    ${company.city ? `<span>üìç ${company.city}, SC</span>` : ''}
                                    ${company.employees ? `<span>üë• ${company.employees} funcion√°rios</span>` : ''}
                                    ${company.industry ? `<span>üè≠ ${company.industry}</span>` : ''}
                                </div>
                                ${company.phone ? `<div class="mb-2">üìû ${company.phone}</div>` : ''}
                                
                                ${socialLinks.length > 0 ? `
                                    <div class="flex gap-3 text-sm flex-wrap">
                                        ${socialLinks.join(' ‚Ä¢ ')}
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${company.website ? `
                                <a href="${company.website}" target="_blank" 
                                   class="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 whitespace-nowrap ml-4">
                                    üåê Visitar Site
                                </a>
                            ` : ''}
                        </div>
                    </div>

                    <div class="p-6">
                        <h4 class="font-semibold mb-4">üë§ Decisores (${company.contacts ? company.contacts.length : 0})</h4>
                        ${!company.contacts || company.contacts.length === 0 ? 
                            '<p class="text-gray-500 italic">Nenhum decisor encontrado</p>' :
                            `<div class="space-y-3">${company.contacts.map(contact => 
                                renderContact(contact, company.name)).join('')}</div>`
                        }
                    </div>
                </div>
            `;
        }

function renderContact(contact, companyName) {
    const isEnriched = enrichedContacts[contact.id];
    const contactJson = JSON.stringify(contact).replace(/"/g, '&quot;');
    const companyNameEscaped = companyName.replace(/"/g, '&quot;').replace(/'/g, "\\'");
    
    // Mostrar TODOS los emails y tel√©fonos de Apollo
    const hasApolloData = contact.emails_apollo?.length > 0 || contact.phones_apollo?.length > 0;
    
    return `
        <div class="border rounded-lg p-4">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <h5 class="font-semibold">${contact.name || 'Sem nome'}</h5>
                        ${contact.seniority === 'owner' ? 
                            '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">üëë OWNER</span>' : 
                            ''}
                        ${contact.seniority === 'c_suite' ? 
                            '<span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full">CEO</span>' : 
                            ''}
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${contact.title || ''}</p>
                    
                    ${contact.linkedin_url ? 
                        `<a href="${contact.linkedin_url}" target="_blank" class="text-blue-600 text-sm hover:underline block mb-2">
                            üîó LinkedIn
                        </a>` : 
                        ''}

                    ${hasApolloData ? `
                        <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded">
                            <p class="text-xs font-semibold text-blue-800 mb-1">üìä Dados Apollo (gr√°tis)</p>
                            
                            ${contact.emails_apollo && contact.emails_apollo.length > 0 ? `
                                <div class="mb-2">
                                    <p class="text-xs font-medium text-gray-700">Emails:</p>
                                    ${contact.emails_apollo.map(email => 
                                        `<p class="text-sm text-gray-800">‚úâÔ∏è ${email}</p>`
                                    ).join('')}
                                </div>
                            ` : ''}
                            
                            ${contact.phones_apollo && contact.phones_apollo.length > 0 ? `
                                <div>
                                    <p class="text-xs font-medium text-gray-700">Telefones:</p>
                                    ${contact.phones_apollo.map(phone => 
                                        `<p class="text-sm text-gray-800">üìû ${phone.number} <span class="text-xs text-gray-500">(${phone.type})</span></p>`
                                    ).join('')}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    ${isEnriched ? `
                        <div class="mt-2 p-3 bg-green-50 border border-green-200 rounded">
                            <p class="text-xs font-semibold text-green-800 mb-1">‚úÖ Enriquecido com Lusha</p>
                            ${isEnriched.emails && isEnriched.emails.length > 0 ? `
                                <div class="mb-2">
                                    <p class="text-xs font-medium text-gray-700">Emails Lusha:</p>
                                    ${isEnriched.emails.map(email => 
                                        `<p class="text-sm text-gray-800">‚úâÔ∏è ${email}</p>`
                                    ).join('')}
                                </div>
                            ` : ''}
                            ${isEnriched.phones && isEnriched.phones.length > 0 ? `
                                <div>
                                    <p class="text-xs font-medium text-gray-700">Telefones Lusha:</p>
                                    ${isEnriched.phones.map(phone => 
                                        `<p class="text-sm text-gray-800">üìû ${phone}</p>`
                                    ).join('')}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>

                ${!isEnriched && contact.needs_enrichment ? `
                    <button onclick='enrichContact(${contactJson}, "${companyNameEscaped}")' 
                            class="ml-4 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap">
                        üí∞ Enriquecer Lusha
                    </button>
                ` : ''}
            </div>
        </div>
    `;
}

async function enrichContact(contact, companyName) {
    if (!contact.linkedin_url) {
        alert('‚ùå Precisa de LinkedIn URL para enriquecer');
        return;
    }

    if (!confirm(`Usar 1 cr√©dito Lusha para enriquecer ${contact.name}?`)) {
        return;
    }

    try {
        const response = await fetch('/api/2-enrich-contact', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contact: {
                    id: contact.id,
                    name: contact.name,
                    company: companyName,
                    linkedin_url: contact.linkedin_url
                }
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            enrichedContacts[contact.id] = {
                emails: data.enriched_data.emails || [],
                phones: data.enriched_data.phones || [],
                enriched: true
            };
            localStorage.setItem('enriched_contacts', JSON.stringify(enrichedContacts));
            
            const currentCredits = parseInt(document.getElementById('lusha-credits').textContent);
            document.getElementById('lusha-credits').textContent = currentCredits + 1;
            
            const emailsText = data.enriched_data.emails?.join('\n') || 'Nenhum';
            const phonesText = data.enriched_data.phones?.join('\n') || 'Nenhum';
            
            alert(`‚úÖ Contato enriquecido!\n\nEmails:\n${emailsText}\n\nTelefones:\n${phonesText}`);
            
            searchCompanies();
        } else {
            alert('‚ùå Falha: ' + data.error);
        }
    } catch (error) {
        console.error('Enrichment error:', error);
        alert('Erro ao enriquecer contato');
    }
}
    </script>
</body>
</html>
